<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consentimiento Informado - Tatuaje</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.4;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            animation: slideIn 0.8s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .form-content {
            padding: 40px;
        }

        .form-group {
            margin-bottom: 25px;
            position: relative;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-row-triple {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, textarea, select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e6ed;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            transform: translateY(-2px);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
            margin: 40px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
            position: relative;
        }

        .section-title::before {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 50px;
            height: 3px;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .info-section {
            background: linear-gradient(135deg, #f8f9ff, #e8f0ff);
            padding: 25px;
            border-radius: 15px;
            margin: 25px 0;
            border-left: 5px solid #3498db;
        }

        .info-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .info-section p {
            color: #5a6c7d;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .signature-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
            text-align: center;
        }

        .signature-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .signature-pad {
            border: 2px dashed #3498db;
            border-radius: 12px;
            background: white;
            cursor: crosshair;
            transition: all 0.3s ease;
        }

        .signature-pad:hover {
            border-color: #2980b9;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.2);
        }

        .signature-controls {
            margin-top: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            font-size: 16px;
            padding: 15px 30px;
            margin-top: 20px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 15px;
            background: rgba(52, 152, 219, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(52, 152, 219, 0.2);
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            transform: scale(1.2);
        }

        .checkbox-group label {
            margin-bottom: 0;
            font-weight: normal;
            text-transform: none;
            letter-spacing: normal;
        }

        .date-location {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
            text-align: center;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .form-row, .form-row-triple {
                grid-template-columns: 1fr;
            }
            
            .signature-container {
                grid-template-columns: 1fr;
            }
            
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .form-content {
                padding: 20px;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>FORMULARIO DE CONSENTIMIENTO INFORMADO</h1>
            <p>C/ LOS ALCALDES 13, ARCOS DE LA FRONTERA, CÁDIZ - N.I.F.: 75772358-P</p>
        </div>

        <div class="form-content">
            <form id="consentForm">
                <div class="section-title">DATOS PERSONALES</div>
                
                <div class="form-group">
                    <label for="nombreCompleto">Nombre y Apellidos</label>
                    <input type="text" id="nombreCompleto" name="nombreCompleto" required>
                </div>

                <div class="form-row-triple">
                    <div class="form-group">
                        <label for="fechaNacimiento">Fecha de Nacimiento</label>
                        <input type="date" id="fechaNacimiento" name="fechaNacimiento" required>
                    </div>
                    <div class="form-group">
                        <label for="dni">D.N.I.</label>
                        <input type="text" id="dni" name="dni" required>
                    </div>
                    <div class="form-group">
                        <label for="telefono">Teléfono</label>
                        <input type="tel" id="telefono" name="telefono" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="domicilio">Domicilio</label>
                    <input type="text" id="domicilio" name="domicilio" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="localidad">Localidad</label>
                        <input type="text" id="localidad" name="localidad" required>
                    </div>
                    <div class="form-group">
                        <label for="provincia">Provincia</label>
                        <input type="text" id="provincia" name="provincia" required>
                    </div>
                </div>

                <div class="section-title">INFORMACIÓN DEL TATUAJE</div>

                <div class="form-group">
                    <label for="localizacionAnatomica">Localización Anatómica</label>
                    <input type="text" id="localizacionAnatomica" name="localizacionAnatomica" required>
                </div>

                <div class="form-group">
                    <label for="descripcionTecnica">Descripción Detallada de la Técnica</label>
                    <textarea id="descripcionTecnica" name="descripcionTecnica" rows="3" required></textarea>
                </div>

                <div class="section-title">MATERIALES EMPLEADOS</div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="agujas">Agujas</label>
                        <input type="text" id="agujas" name="agujas" required>
                    </div>
                    <div class="form-group">
                        <label for="tinta">Tinta</label>
                        <input type="text" id="tinta" name="tinta" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="otrosMateriales">Otros Materiales</label>
                    <input type="text" id="otrosMateriales" name="otrosMateriales">
                </div>

                <div class="info-section">
                    <h3>INFORMACIÓN IMPORTANTE SOBRE EL PROCEDIMIENTO</h3>
                    <p><strong>Definición:</strong> Procedimiento de decoración del cuerpo humano mediante la introducción en la piel de pigmentos colorantes por medio de punciones.</p>
                    <p><strong>Permanencia:</strong> Esta técnica es permanente y para toda la vida.</p>
                    <p><strong>Alteraciones:</strong> El paso del tiempo puede suponer una alteración o decoloración de la zona tratada.</p>
                    <p><strong>Medidas Higiénico-Sanitarias:</strong> Limpieza y desinfección del área de trabajo, utilización de materiales esterilizados y de un solo uso.</p>
                </div>

                <div class="info-section">
                    <h3>CONTRAINDICACIONES</h3>
                    <p>Alergias a pigmentos y agujas, lunares, queloides, cicatrices no estabilizadas, enfermedad dermatológica crónica, personas con problemas de cicatrización, angiomas abultados, embarazo, herpes, debilidad inmunológica, infiltraciones médico-estéticas, radioterapia, quimioterapia o dermatitis local.</p>
                </div>

                <div class="form-group">
                    <label for="enfermedadObligatoria">Enfermedad de Declaración Obligatoria (SIDA, Hepatitis B, etc.)</label>
                    <textarea id="enfermedadObligatoria" name="enfermedadObligatoria" rows="2" placeholder="Indique cual o escriba 'Ninguna'"></textarea>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="consentimiento" name="consentimiento" required>
                    <label for="consentimiento">He leído y entiendo toda la información proporcionada. Doy mi consentimiento para la realización del tatuaje descrito. Entiendo que este consentimiento puede ser revocado en cualquier momento antes de la realización de la práctica.</label>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="proteccionDatos" name="proteccionDatos" required>
                    <label for="proteccionDatos">Acepto que estos datos se guarden en un fichero sometido a la Ley de Protección de Datos, pudiendo ejercer mis derechos de acceso, modificación, cancelación y oposición.</label>
                </div>

                <div class="section-title">FIRMAS</div>
                
                <div class="signature-section">
                    <div class="signature-container">
                        <div>
                            <h4>Firma del Cliente</h4>
                            <canvas id="clientSignature" class="signature-pad" width="300" height="150"></canvas>
                            <div class="signature-controls">
                                <button type="button" class="btn btn-secondary" onclick="clearSignature('client')">Limpiar</button>
                            </div>
                        </div>
                        <div>
                            <h4>Firma del Aplicador</h4>
                            <canvas id="applicatorSignature" class="signature-pad" width="300" height="150"></canvas>
                            <div class="signature-controls">
                                <button type="button" class="btn btn-secondary" onclick="clearSignature('applicator')">Limpiar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="date-location">
                    <p>En Arcos de la Frontera, a <span id="currentDate"></span></p>
                </div>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Generando documento PDF...</p>
                </div>

                <div style="text-align: center;">
                    <button type="submit" class="btn btn-success">Generar y Descargar PDF</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Initialize signature pads
        let clientSignaturePad;
        let applicatorSignaturePad;

        document.addEventListener('DOMContentLoaded', function() {
            // Set current date
            const today = new Date();
            const formattedDate = today.toLocaleDateString('es-ES', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            document.getElementById('currentDate').textContent = formattedDate;

            // Wait for libraries to load
            setTimeout(initializeApp, 100);
        });

        function initializeApp() {
            try {
                // Initialize signature pads
                const clientCanvas = document.getElementById('clientSignature');
                const applicatorCanvas = document.getElementById('applicatorSignature');
                
                if (typeof SignaturePad !== 'undefined') {
                    clientSignaturePad = new SignaturePad(clientCanvas);
                    applicatorSignaturePad = new SignaturePad(applicatorCanvas);
                    
                    console.log('Signature pads initialized successfully');
                } else {
                    console.error('SignaturePad library not loaded');
                    alert('Error cargando las firmas. Por favor, recarga la página.');
                    return;
                }

                // Handle form submission
                document.getElementById('consentForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    generatePDF();
                });
                
            } catch (error) {
                console.error('Error initializing app:', error);
                alert('Error inicializando la aplicación: ' + error.message);
            }
        }

        function clearSignature(type) {
            if (type === 'client') {
                clientSignaturePad.clear();
            } else {
                applicatorSignaturePad.clear();
            }
        }

        function generatePDF() {
            try {
                console.log('Starting PDF generation...');
                
                // Check if jsPDF is available
                if (typeof window.jsPDF === 'undefined') {
                    alert('Error: Biblioteca PDF no cargada. Por favor, recarga la página.');
                    return;
                }

                // Check if signatures are present
                if (!clientSignaturePad || clientSignaturePad.isEmpty()) {
                    alert('Por favor, proporcione la firma del cliente.');
                    return;
                }

                if (!applicatorSignaturePad || applicatorSignaturePad.isEmpty()) {
                    alert('Por favor, proporcione la firma del aplicador.');
                    return;
                }

                // Show loading
                document.getElementById('loading').style.display = 'block';

                // Create PDF
                const doc = new window.jsPDF();

                // Get form data
                const formData = new FormData(document.getElementById('consentForm'));
                
                // Header
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('FORMULARIO DE CONSENTIMIENTO INFORMADO', 105, 20, { align: 'center' });
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('C/ LOS ALCALDES 13, ARCOS DE LA FRONTERA, CÁDIZ - N.I.F.: 75772358-P', 105, 28, { align: 'center' });

                // Personal data
                let yPos = 45;
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('DATOS PERSONALES', 20, yPos);
                
                yPos += 10;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('Nombre y Apellidos: ' + (formData.get('nombreCompleto') || ''), 20, yPos);
                yPos += 7;
                doc.text('Fecha de Nacimiento: ' + (formData.get('fechaNacimiento') || '') + ' | DNI: ' + (formData.get('dni') || '') + ' | Telefono: ' + (formData.get('telefono') || ''), 20, yPos);
                yPos += 7;
                doc.text('Domicilio: ' + (formData.get('domicilio') || ''), 20, yPos);
                yPos += 7;
                doc.text('Localidad: ' + (formData.get('localidad') || '') + ' | Provincia: ' + (formData.get('provincia') || ''), 20, yPos);

                // Tattoo information
                yPos += 15;
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('INFORMACION DEL TATUAJE', 20, yPos);
                
                yPos += 10;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('Localizacion Anatomica: ' + (formData.get('localizacionAnatomica') || ''), 20, yPos);
                yPos += 7;
                
                const descripcion = formData.get('descripcionTecnica') || '';
                const descripcionLines = doc.splitTextToSize('Descripcion: ' + descripcion, 170);
                doc.text(descripcionLines, 20, yPos);
                yPos += descripcionLines.length * 5 + 5;

                // Materials
                yPos += 5;
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('MATERIALES EMPLEADOS', 20, yPos);
                
                yPos += 10;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('Agujas: ' + (formData.get('agujas') || '') + ' | Tinta: ' + (formData.get('tinta') || ''), 20, yPos);
                yPos += 7;
                if (formData.get('otrosMateriales')) {
                    doc.text('Otros: ' + formData.get('otrosMateriales'), 20, yPos);
                    yPos += 7;
                }

                // Important information
                yPos += 10;
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('INFORMACION IMPORTANTE', 20, yPos);
                
                yPos += 8;
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                const infoText = "Tecnica permanente para toda la vida. El tiempo puede causar alteracion o decoloracion. Se utilizan materiales esterilizados y de un solo uso.";
                const infoLines = doc.splitTextToSize(infoText, 170);
                doc.text(infoLines, 20, yPos);
                yPos += infoLines.length * 5 + 5;

                // Contraindications
                yPos += 5;
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('CONTRAINDICACIONES', 20, yPos);
                
                yPos += 8;
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                const contraText = "Alergias, lunares, queloides, cicatrices no estabilizadas, enfermedad dermatologica cronica, problemas de cicatrizacion, angiomas, embarazo, herpes, debilidad inmunologica, infiltraciones, radioterapia, quimioterapia o dermatitis.";
                const contraLines = doc.splitTextToSize(contraText, 170);
                doc.text(contraLines, 20, yPos);
                yPos += contraLines.length * 5 + 10;

                // Disease declaration
                if (formData.get('enfermedadObligatoria')) {
                    doc.text('Enfermedad de declaracion obligatoria: ' + formData.get('enfermedadObligatoria'), 20, yPos);
                    yPos += 10;
                }

                // Add new page if needed
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }

                // Signatures
                yPos += 10;
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('FIRMAS', 20, yPos);
                
                yPos += 15;
                
                // Client signature
                const clientSignatureData = clientSignaturePad.toDataURL();
                doc.addImage(clientSignatureData, 'PNG', 20, yPos, 60, 25);
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('Firma del Cliente', 40, yPos + 30);

                // Applicator signature
                const applicatorSignatureData = applicatorSignaturePad.toDataURL();
                doc.addImage(applicatorSignatureData, 'PNG', 120, yPos, 60, 25);
                doc.text('Firma del Aplicador', 135, yPos + 30);

                // Date and location
                yPos += 45;
                doc.text('En Arcos de la Frontera, a ' + document.getElementById('currentDate').textContent, 105, yPos, { align: 'center' });

                // Hide loading
                document.getElementById('loading').style.display = 'none';

                // Ask for filename
                const nombreCliente = formData.get('nombreCompleto') || 'Cliente';
                const fechaActual = new Date().toISOString().split('T')[0];
                const nombreSugerido = 'Consentimiento_' + nombreCliente.replace(/\s+/g, '_') + '_' + fechaActual;
                
                const nombreArchivo = prompt(
                    'Ingrese el nombre para el archivo PDF:\n(Sin extensión .pdf)', 
                    nombreSugerido
                );
                
                if (nombreArchivo === null) {
                    // Usuario canceló
                    return;
                }
                
                if (nombreArchivo.trim() === '') {
                    alert('Debe ingresar un nombre para el archivo.');
                    return;
                }
                
                // Clean filename and add .pdf extension
                const cleanFileName = nombreArchivo.trim().replace(/[<>:"/\\|?*]/g, '_') + '.pdf';
                doc.save(cleanFileName);
                
                console.log('PDF generated successfully: ' + cleanFileName);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                document.getElementById('loading').style.display = 'none';
                alert('Error generando el PDF: ' + error.message + '\nPor favor, recarga la página e intenta de nuevo.');
            }
        }

        // Responsive signature pad resizing
        function resizeSignaturePads() {
            const canvases = document.querySelectorAll('.signature-pad');
            canvases.forEach(canvas => {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                const parentWidth = canvas.parentElement.offsetWidth - 40;
                canvas.width = parentWidth * ratio;
                canvas.height = 150 * ratio;
                canvas.style.width = parentWidth + 'px';
                canvas.style.height = '150px';
                canvas.getContext('2d').scale(ratio, ratio);
            });
        }

        window.addEventListener('resize', resizeSignaturePads);
        window.addEventListener('load', resizeSignaturePads);
    </script>
</body>
</html>
